name: Docker Security Scan - Alpine

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    
permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

jobs:
  # ========== MAIN SECURITY SCAN ==========
  security-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # ========== LINTING ==========
    - name: Install Hadolint
      id: install_hadolint
      run: |
        echo "üì• Installing Hadolint..."
        curl -L -o hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
        chmod +x hadolint
        sudo mv hadolint /usr/local/bin/
        hadolint --version
        echo "‚úÖ Hadolint installed successfully"

    - name: Run Hadolint
      id: hadolint
      run: |
        echo "üîç Checking for Dockerfile..."
        
        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå Dockerfile not found for Hadolint"
          echo '[]' > hadolint-results.json
          exit 0
        fi
        
        echo "‚úÖ Running Hadolint on Dockerfile"
        /usr/local/bin/hadolint --format json Dockerfile > hadolint-results.json || true

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ -s hadolint-results.json ]; then
          HADOLINT_ISSUES=$(jq '. | length' hadolint-results.json 2>/dev/null || echo "0")
          echo "üìä Hadolint found $HADOLINT_ISSUES issues"
        else
          echo "‚úÖ Hadolint completed - no issues found"
        fi
      
    - name: Check for .dockerignore
      id: dockerignore_check
      run: |
        if [ -f ".dockerignore" ]; then
          echo "dockerignore_exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ .dockerignore file found"
        else
          echo "dockerignore_exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No .dockerignore file found"
        fi

    # ========== BUILD STAGE ==========
    - name: Build Docker image
      id: build
      continue-on-error: true
      run: |
        echo "üèóÔ∏è Building Docker image..."
        
        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå ERROR: Dockerfile not found in current directory"
          echo "Current directory content:"
          ls -la
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "‚úÖ Dockerfile found. Content preview:"
        head -5 Dockerfile
        
        set +e
        echo "üî® Starting Docker build..."
        docker build --progress=plain -t alpine-secure:latest . 2>&1 | tee build-output.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Docker build successful"
          echo "build_success=true" >> $GITHUB_OUTPUT
          
          echo "üíæ Saving Docker image to tar.gz..."
          docker save alpine-secure:latest | gzip > alpine-secure-image.tar.gz
          ls -lh alpine-secure-image.tar.gz
          
          echo "üß™ Testing Alpine image basics..."
          docker run --rm alpine-secure:latest cat /etc/alpine-release || echo "Release check failed"
          docker run --rm alpine-secure:latest whoami || echo "User check failed"
        else
          echo "‚ùå Docker build failed with exit code: $BUILD_EXIT_CODE"
          echo "build_success=false" >> $GITHUB_OUTPUT
          echo "=== LAST 20 LINES OF BUILD ERRORS ==="
          tail -20 build-output.log || echo "No build output available"
        fi

    # ========== INSTALL SECURITY TOOLS ==========
    - name: Install security tools
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "üîß Installing security tools..."
        
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
        
        sudo apt-get update && sudo apt-get install -y jq
        
        echo "‚úÖ Tools installed successfully"

    # ========== SBOM GENERATION ==========
    - name: Generate SBOM
      if: steps.build.outputs.build_success == 'true'
      id: sbom_generation
      run: |
        echo "üìã Generating SBOM for Alpine image..."
        
        syft alpine-secure:latest -o cyclonedx-json > sbom.cyclonedx.json
        syft alpine-secure:latest -o spdx-json > sbom.spdx.json
        syft alpine-secure:latest -o syft-json > sbom.syft.json
        
        COMPONENT_COUNT=$(jq '.components | length' sbom.cyclonedx.json)
        ALPINE_COMPONENTS=$(jq '[.components[] | select(.purl != null) | select(.purl | type == "string") | select(.purl | startswith("pkg:apk/alpine"))] | length' sbom.cyclonedx.json)
        ALPINE_VERSION=$(docker run --rm --entrypoint cat alpine-secure:latest /etc/alpine-release 2>/dev/null | tr -d '\r' || echo "unknown")
        echo "component_count=$COMPONENT_COUNT" >> $GITHUB_OUTPUT
        echo "alpine_components=$ALPINE_COMPONENTS" >> $GITHUB_OUTPUT
        echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT
        
        echo "‚úÖ SBOM generated with $COMPONENT_COUNT components ($ALPINE_COMPONENTS Alpine packages)"
        echo "üì¶ Alpine version: $ALPINE_VERSION"

    # ========== VULNERABILITY SCANNING ==========
    - name: Scan SBOM with Grype (with ignore rules and debug)
      if: steps.build.outputs.build_success == 'true'
      id: sbom_scan
      run: |
        echo "üîç Scanning SBOM with Grype (with ignore rules)..."
        
        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        echo "üìÅ Current directory:"
        ls -la | grep -E "(grype|\.yaml)" || echo "No grype config files found"
        
        # –°–æ–∑–¥–∞–µ–º –Ω–∞–¥–µ–∂–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
        cat > /tmp/grype-config-debug.yaml << 'EOF'
        ignore:
          # –Ø–≤–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ CVE
          - vulnerability: "CVE-2025-46394"
            reason: "Ignore in busybox components"
            
          - vulnerability: "CVE-2024-58251"  
            reason: "Ignore in busybox components"
        EOF

        echo "üîß Grype config content:"
        cat /tmp/grype-config-debug.yaml
        echo ""
        
        # –°–∫–∞–Ω–∏—Ä—É–µ–º —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
        echo "üöÄ Running Grype scan..."
        grype sbom:sbom.cyclonedx.json --config /tmp/grype-config-debug.yaml --output json --verbose > sbom-scan-all-severities.json 2>grype-debug.log || true
        
        echo "=== Grype debug output ==="
        cat grype-debug.log || echo "No debug output"
        echo "=========================="
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if [ -f sbom-scan-all-severities.json ]; then
          echo "‚úÖ Scan completed, checking ignored vulnerabilities..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Ü–µ–ª–µ–≤—ã–µ CVE
          IGNORED_CVES=$(jq -r '[.matches[] | select(.vulnerability.id | test("CVE-2025-46394|CVE-2024-58251")) | .vulnerability.id] | unique[]' sbom-scan-all-severities.json 2>/dev/null || echo "")
          
          if [ -n "$IGNORED_CVES" ]; then
            echo "‚ùå These CVE were NOT ignored:"
            echo "$IGNORED_CVES"
            
            # –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ—É–¥–∞–ª–µ–Ω–Ω—ã—Ö CVE
            echo "üîç Details of non-ignored CVE:"
            jq -r '.matches[] | select(.vulnerability.id | test("CVE-2025-46394|CVE-2024-58251")) | "\(.vulnerability.id) - \(.artifact.name)@\(.artifact.version) - \(.vulnerability.severity)"' sbom-scan-all-severities.json 2>/dev/null || echo "No details available"
          else
            echo "‚úÖ Target CVE successfully ignored!"
          fi
          
          # –û–±—â–∏–π –ø–æ–¥—Å—á–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
          SBOM_VULN_COUNT=$(jq '.matches // [] | length' sbom-scan-all-severities.json 2>/dev/null || echo "0")
          SBOM_CRITICAL_COUNT=$(jq '[.matches // [] | select(.vulnerability.severity == "Critical")] | length' sbom-scan-all-severities.json 2>/dev/null || echo "0")
          SBOM_HIGH_COUNT=$(jq '[.matches // [] | select(.vulnerability.severity == "High")] | length' sbom-scan-all-severities.json 2>/dev/null || echo "0")
          SBOM_MEDIUM_COUNT=$(jq '[.matches // [] | select(.vulnerability.severity == "Medium")] | length' sbom-scan-all-severities.json 2>/dev/null || echo "0")
          SBOM_LOW_COUNT=$(jq '[.matches // [] | select(.vulnerability.severity == "Low")] | length' sbom-scan-all-severities.json 2>/dev/null || echo "0")
          SBOM_UNKNOWN_COUNT=$(jq '[.matches // [] | select(.vulnerability.severity == "Unknown")] | length' sbom-scan-all-severities.json 2>/dev/null || echo "0")
          SBOM_NONE_COUNT=$(jq '[.matches // [] | select(.vulnerability.severity == "None" or .vulnerability.severity == "" or .vulnerability.severity == null)] | length' sbom-scan-all-severities.json 2>/dev/null || echo "0")

          # –í—Å–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∫—Ä–æ–º–µ "None" –∏ –ø—É—Å—Ç—ã—Ö
          SBOM_REAL_VULN_COUNT=$((SBOM_CRITICAL_COUNT + SBOM_HIGH_COUNT + SBOM_MEDIUM_COUNT + SBOM_LOW_COUNT + SBOM_UNKNOWN_COUNT))
          
          echo "sbom_vuln_count=$SBOM_VULN_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_real_vuln_count=$SBOM_REAL_VULN_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_critical_count=$SBOM_CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_high_count=$SBOM_HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_medium_count=$SBOM_MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_low_count=$SBOM_LOW_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_unknown_count=$SBOM_UNKNOWN_COUNT" >> $GITHUB_OUTPUT
          echo "sbom_none_count=$SBOM_NONE_COUNT" >> $GITHUB_OUTPUT
          
          echo "üìä SBOM scan found: $SBOM_VULN_COUNT total matches"
          echo "üìä Real vulnerabilities: $SBOM_REAL_VULN_COUNT (excluding 'None' severity)"
          echo "üìä Breakdown - Critical: $SBOM_CRITICAL_COUNT, High: $SBOM_HIGH_COUNT, Medium: $SBOM_MEDIUM_COUNT, Low: $SBOM_LOW_COUNT, Unknown: $SBOM_UNKNOWN_COUNT, None: $SBOM_NONE_COUNT"
          
          # –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          echo "üîç Detailed vulnerability analysis:"
          jq -r '.matches[] | "\(.vulnerability.severity) - \(.vulnerability.id) - \(.artifact.name)@\(.artifact.version)"' sbom-scan-all-severities.json 2>/dev/null | head -20 || echo "No vulnerabilities to display"
          
          echo "## Detailed Vulnerability Report" > grype-detailed-report.md
          echo "" >> grype-detailed-report.md
          echo "| Severity | CVE ID | Package | Version | Description |" >> grype-detailed-report.md
          echo "|----------|--------|---------|---------|-------------|" >> grype-detailed-report.md
          jq -r '.matches[] | "| \(.vulnerability.severity) | \(.vulnerability.id) | \(.artifact.name) | \(.artifact.version) | \(.vulnerability.description // "No description") |"' sbom-scan-all-severities.json 2>/dev/null >> grype-detailed-report.md
          
        else
          echo "sbom_vuln_count=0" >> $GITHUB_OUTPUT
          echo "sbom_real_vuln_count=0" >> $GITHUB_OUTPUT
          echo "sbom_critical_count=0" >> $GITHUB_OUTPUT
          echo "sbom_high_count=0" >> $GITHUB_OUTPUT
          echo "sbom_medium_count=0" >> $GITHUB_OUTPUT
          echo "sbom_low_count=0" >> $GITHUB_OUTPUT
          echo "sbom_unknown_count=0" >> $GITHUB_OUTPUT
          echo "sbom_none_count=0" >> $GITHUB_OUTPUT
          echo "üìä SBOM scan completed - no vulnerabilities found"
        fi
        
    - name: Generate package table with vulnerabilities
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "üìä Generating package table with vulnerabilities..."
        
        if [ -f "sbom.cyclonedx.json" ] && [ -f "sbom-scan-all-severities.json" ]; then
          # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–∞–∫–µ—Ç–æ–≤
          echo "## üì¶ Packages in Image with Vulnerability Count" > package-table.md
          echo "" >> package-table.md
          echo "| Package | Version | Type | Vulnerabilities |" >> package-table.md
          echo "|---------|---------|------|----------------|" >> package-table.md
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å —É—è–∑–≤–∏–º–æ—Å—Ç—è–º–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
          jq -r '.matches[]? | "\(.artifact.name) \(.artifact.version) \(.vulnerability.severity)"' sbom-scan-all-severities.json > vulns.txt 2>/dev/null || touch vulns.txt
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–∞–∫–µ—Ç—ã –∏–∑ SBOM
          jq -r '.components[]? | select(.type == "library" or .type == "application") | select(.name != "command-line-arguments") | "\(.name | sub("^.*/"; "")) \(.version) \(.purl | split("/")[0] | split(":")[2]? // "apk")"' sbom.cyclonedx.json | while read -r name version type; do
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            critical=0
            high=0
            medium=0
            low=0
            unknown=0
            
            # –ò—â–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞
            if [ -f "vulns.txt" ]; then
              while read -r vuln_name vuln_version vuln_severity; do
                if [ "$vuln_name" = "$name" ] && [ "$vuln_version" = "$version" ]; then
                  case "$vuln_severity" in
                    "Critical") critical=$((critical + 1)) ;;
                    "High") high=$((high + 1)) ;;
                    "Medium") medium=$((medium + 1)) ;;
                    "Low") low=$((low + 1)) ;;
                    *) unknown=$((unknown + 1)) ;;
                  esac
                fi
              done < vulns.txt
            fi
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
            echo "| $name | $version | $type | \`$critical $high $medium $low $unknown\` |" >> package-table.md
          done
          
          echo "" >> package-table.md
          echo "**Vulnerabilities Format:** \`Critical High Medium Low Unknown\`" >> package-table.md
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          total_vulns=$(wc -l < vulns.txt 2>/dev/null || echo "0")
          echo "" >> package-table.md
          echo "**Total vulnerabilities found:** $total_vulns" >> package-table.md
          
          # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ command-line-arguments
          echo "" >> package-table.md
          echo "**Note:** Package 'command-line-arguments' with version 'UNKNOWN' is excluded from this table as it is a Go build artifact, not a real package." >> package-table.md
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -f vulns.txt
          
          echo "‚úÖ Package table with real vulnerability counts generated"
        else
          echo "‚ùå SBOM or vulnerability files not found"
          echo "# üì¶ Packages in Image" > package-table.md
          echo "" >> package-table.md
          echo "No package information available" >> package-table.md
        fi
        
    # ========== VULNERABILITY SCANNING - ALL SEVERITIES ==========
    - name: Run Trivy vulnerability scan (ALL severities)
      if: steps.build.outputs.build_success == 'true'
      id: trivy_scan
      run: |
        echo "üîç Running Trivy scan (ALL severities)..."
        
        trivy image --format json --output trivy-results-all-severities.json alpine-secure:latest
        trivy image --format table --output trivy-report.txt alpine-secure:latest

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Trivy
        if [ -f "trivy-results-all-severities.json" ] && jq -e . trivy-results-all-severities.json > /dev/null 2>&1; then
          TRIVY_CRITICAL=$(jq '[.Results[0].Vulnerabilities // [] | select(.Severity == "CRITICAL")] | length' trivy-results-all-severities.json 2>/dev/null || echo "0")
          TRIVY_HIGH=$(jq '[.Results[0].Vulnerabilities // [] | select(.Severity == "HIGH")] | length' trivy-results-all-severities.json 2>/dev/null || echo "0")
          TRIVY_MEDIUM=$(jq '[.Results[0].Vulnerabilities // [] | select(.Severity == "MEDIUM")] | length' trivy-results-all-severities.json 2>/dev/null || echo "0")
          TRIVY_LOW=$(jq '[.Results[0].Vulnerabilities // [] | select(.Severity == "LOW")] | length' trivy-results-all-severities.json 2>/dev/null || echo "0")
          TRIVY_UNKNOWN=$(jq '[.Results[0].Vulnerabilities // [] | select(.Severity == "UNKNOWN")] | length' trivy-results-all-severities.json 2>/dev/null || echo "0")
          TRIVY_TOTAL=$((TRIVY_CRITICAL + TRIVY_HIGH + TRIVY_MEDIUM + TRIVY_LOW + TRIVY_UNKNOWN))
          
          echo "trivy_critical_count=$TRIVY_CRITICAL" >> $GITHUB_OUTPUT
          echo "trivy_high_count=$TRIVY_HIGH" >> $GITHUB_OUTPUT
          echo "trivy_medium_count=$TRIVY_MEDIUM" >> $GITHUB_OUTPUT
          echo "trivy_low_count=$TRIVY_LOW" >> $GITHUB_OUTPUT
          echo "trivy_unknown_count=$TRIVY_UNKNOWN" >> $GITHUB_OUTPUT
          echo "trivy_total_count=$TRIVY_TOTAL" >> $GITHUB_OUTPUT
          
          echo "üìä Trivy found: $TRIVY_TOTAL vulnerabilities"
          echo "üìä Breakdown - CRITICAL: $TRIVY_CRITICAL, HIGH: $TRIVY_HIGH, MEDIUM: $TRIVY_MEDIUM, LOW: $TRIVY_LOW, UNKNOWN: $TRIVY_UNKNOWN"
        else
          echo "trivy_critical_count=0" >> $GITHUB_OUTPUT
          echo "trivy_high_count=0" >> $GITHUB_OUTPUT
          echo "trivy_medium_count=0" >> $GITHUB_OUTPUT
          echo "trivy_low_count=0" >> $GITHUB_OUTPUT
          echo "trivy_unknown_count=0" >> $GITHUB_OUTPUT
          echo "trivy_total_count=0" >> $GITHUB_OUTPUT
          echo "üìä Trivy scan completed - no vulnerabilities found"
        fi
        
        echo "‚úÖ Trivy scan completed for all severities"

    # ========== DOCKERFILE ANALYSIS ==========
    - name: Run custom Dockerfile analysis
      if: steps.build.outputs.build_success == 'true'
      id: analysis
      env:
        BUILD_SUCCESS: ${{ steps.build.outputs.build_success }}
        DOCKERIGNORE_EXISTS: ${{ steps.dockerignore_check.outputs.dockerignore_exists }}
        SBOM_COMPONENT_COUNT: ${{ steps.sbom_generation.outputs.component_count }}
        SBOM_ALPINE_COMPONENTS: ${{ steps.sbom_generation.outputs.alpine_components }}
        SBOM_REAL_VULN_COUNT: ${{ steps.sbom_scan.outputs.sbom_real_vuln_count }}
        SBOM_CRITICAL_COUNT: ${{ steps.sbom_scan.outputs.sbom_critical_count }}
        SBOM_HIGH_COUNT: ${{ steps.sbom_scan.outputs.sbom_high_count }}
        SBOM_MEDIUM_COUNT: ${{ steps.sbom_scan.outputs.sbom_medium_count }}
        SBOM_LOW_COUNT: ${{ steps.sbom_scan.outputs.sbom_low_count }}
        SBOM_UNKNOWN_COUNT: ${{ steps.sbom_scan.outputs.sbom_unknown_count }}
        ALPINE_VERSION: ${{ steps.sbom_generation.outputs.alpine_version }}
      run: |
        set +e
        
        echo "## üìã Alpine Dockerfile Security Analysis" > analysis-results.md
        echo "" >> analysis-results.md
        echo "**Scan date:** $(date)" >> analysis-results.md
        echo "**Commit:** ${{ github.sha }}" >> analysis-results.md
        echo "**Branch:** ${{ github.ref }}" >> analysis-results.md
        echo "**Alpine version:** $ALPINE_VERSION" >> analysis-results.md
        echo "" >> analysis-results.md
        
        if [ ! -f "Dockerfile" ]; then
          echo "‚ùå **ERROR**: Dockerfile not found for analysis" >> analysis-results.md
          echo "issue_count=1" >> $GITHUB_OUTPUT
          echo "critical_count=1" >> $GITHUB_OUTPUT
          echo "high_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "**Dockerfile location:** ./Dockerfile" >> analysis-results.md
        echo "" >> analysis-results.md

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ - –¢–û–õ–¨–ö–û –î–õ–Ø DOCKERFILE ISSUES
        DOCKERFILE_ISSUE_COUNT=0
        CRITICAL_COUNT=0
        HIGH_COUNT=0
        MEDIUM_COUNT=0
        LOW_COUNT=0
        
        echo "### üîç Dockerfile Configuration Issues:" >> analysis-results.md
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏ Dockerfile...
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        LAST_USER=$(grep "^USER " Dockerfile | tail -1 2>/dev/null || echo "")
        USER_CREATED=$(grep -E "adduser|useradd|addgroup|groupadd" Dockerfile 2>/dev/null | head -1 || echo "")

        if [[ -n "$LAST_USER" && "$LAST_USER" != "USER root" && "$LAST_USER" != "USER 0" ]]; then
          echo "‚úÖ Non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $LAST_USER" >> analysis-results.md
        elif [ -n "$USER_CREATED" ]; then
          echo "‚úÖ –°–æ–∑–¥–∞–Ω non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $USER_CREATED" >> analysis-results.md
        else
          echo "‚ö†Ô∏è **WARNING**: –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          HIGH_COUNT=$((HIGH_COUNT + 1))
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ ADD vs COPY
        if grep "ADD" Dockerfile > /dev/null 2>&1; then
          echo "‚ùå **WARNING**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ADD –≤–º–µ—Å—Ç–æ COPY" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
        else
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è COPY –≤–º–µ—Å—Ç–æ ADD" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –±–µ–∑ –≤–µ—Ä—Å–∏–π
        BASE_IMAGE=$(grep "^FROM " Dockerfile | head -1)
        if echo "$BASE_IMAGE" | grep -E ":(latest| )" > /dev/null 2>&1 || 
           echo "$BASE_IMAGE" | grep -E "^FROM [^:]+$" > /dev/null 2>&1; then
          echo "‚ö†Ô∏è **WARNING**: –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏: $BASE_IMAGE" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
        else
          echo "‚úÖ –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ —Å –≤–µ—Ä—Å–∏–µ–π: $BASE_IMAGE" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ curl | bash
        if grep -E "curl.*\|.*bash" Dockerfile > /dev/null 2>&1 || 
           grep -E "wget.*\|.*bash" Dockerfile > /dev/null 2>&1; then
          echo "üö® **CRITICAL**: –û–±–Ω–∞—Ä—É–∂–µ–Ω –æ–ø–∞—Å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω 'curl/wget | bash'" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
        else
          echo "‚úÖ –ù–µ—Ç –æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ 'curl/wget | bash'" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ 777
        if grep -E "chmod.*777" Dockerfile > /dev/null 2>&1 || 
           grep -E "777" Dockerfile > /dev/null 2>&1; then
          echo "üö® **CRITICAL**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ 777" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
        else
          echo "‚úÖ –ù–µ—Ç –æ–ø–∞—Å–Ω—ã—Ö –ø—Ä–∞–≤ 777" >> analysis-results.md
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ .dockerignore
        if [ "$DOCKERIGNORE_EXISTS" = "false" ]; then
          echo "‚ö†Ô∏è **WARNING**: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç .dockerignore —Ñ–∞–π–ª" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          LOW_COUNT=$((LOW_COUNT + 1))
        else
          echo "‚úÖ .dockerignore —Ñ–∞–π–ª –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç" >> analysis-results.md
        fi
        
        # –ó–¥–µ—Å—å –ù–ï –ø–∏—à–µ–º "No Dockerfile configuration issues found", —Ç–∞–∫ –∫–∞–∫ –Ω–∏–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∞ Hadolint
        
        # Security Scan Results - –û–¢–î–ï–õ–¨–ù–´–ô –†–ê–ó–î–ï–õ
        echo "" >> analysis-results.md
        echo "### üîí Security Vulnerability Scan:" >> analysis-results.md
        
        if [ "$BUILD_SUCCESS" = "true" ]; then
          echo "‚úÖ **Software Bill of Materials generated**" >> analysis-results.md
          echo "- **Alpine version:** $ALPINE_VERSION" >> analysis-results.md
          echo "- **Total components:** $SBOM_COMPONENT_COUNT" >> analysis-results.md
          echo "- **Alpine packages:** $SBOM_ALPINE_COMPONENTS" >> analysis-results.md
          
          if [ "$SBOM_REAL_VULN_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è **Vulnerabilities found:** $SBOM_REAL_VULN_COUNT vulnerabilities detected" >> analysis-results.md
            if [ "$SBOM_CRITICAL_COUNT" -gt 0 ]; then
              echo "  - üö® Critical: $SBOM_CRITICAL_COUNT" >> analysis-results.md
            fi
            if [ "$SBOM_HIGH_COUNT" -gt 0 ]; then
              echo "  - üî¥ High: $SBOM_HIGH_COUNT" >> analysis-results.md
            fi
            if [ "$SBOM_MEDIUM_COUNT" -gt 0 ]; then
              echo "  - üü° Medium: $SBOM_MEDIUM_COUNT" >> analysis-results.md
            fi
            if [ "$SBOM_LOW_COUNT" -gt 0 ]; then
              echo "  - üîµ Low: $SBOM_LOW_COUNT" >> analysis-results.md
            fi
            if [ "$SBOM_UNKNOWN_COUNT" -gt 0 ]; then
              echo "  - ‚ö™ Unknown: $SBOM_UNKNOWN_COUNT" >> analysis-results.md
            fi
          else
            echo "‚úÖ **Security scan completed - no vulnerabilities found**" >> analysis-results.md
          fi
        fi
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∫–∏
        echo "" >> analysis-results.md
        echo "### üõ† Build Results:" >> analysis-results.md
        if [ "$BUILD_SUCCESS" = "false" ]; then
          echo "üö® **CRITICAL**: Docker image failed to build!" >> analysis-results.md
          DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + 1))
          CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
        else
          echo "‚úÖ Docker image built successfully" >> analysis-results.md
          echo "‚úÖ Docker image saved: alpine-secure-image.tar.gz" >> analysis-results.md
        fi
        
        # –ê–Ω–∞–ª–∏–∑ Hadolint
        HADOLINT_COUNT=0
        if [ -f hadolint-results.json ]; then
          echo "" >> analysis-results.md
          echo "### üìù Dockerfile Linter (Hadolint):" >> analysis-results.md
          
          if jq -e . hadolint-results.json > /dev/null 2>&1; then
            HADOLINT_COUNT=$(jq '. | length' hadolint-results.json 2>/dev/null || echo "0")
            if [ "$HADOLINT_COUNT" -gt 0 ]; then
              # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–∫–∏ DL1000
              echo "**Found $HADOLINT_COUNT Hadolint issues:**" >> analysis-results.md
              echo "" >> analysis-results.md
              jq -r '.[] | "‚Ä¢ **\(.level)**: \(.message) (–∫–æ–¥: \(.code))"' hadolint-results.json 2>/dev/null >> analysis-results.md
              echo "" >> analysis-results.md
              # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è DL1000
              if grep -q "DL1000" hadolint-results.json; then
                echo "**Explanation for DL1000:** This error typically occurs when there's a malformed instruction in Dockerfile, like an unexpected '|' character. Check for missing backslashes (\\) in multi-line RUN commands." >> analysis-results.md
                echo "" >> analysis-results.md
              fi
              DOCKERFILE_ISSUE_COUNT=$((DOCKERFILE_ISSUE_COUNT + HADOLINT_COUNT))
            else
              echo "‚úÖ No Hadolint issues found" >> analysis-results.md
            fi
          fi
        fi
        
        # –û–ë–©–ò–ô –ò–¢–û–ì - –¢–û–õ–¨–ö–û DOCKERFILE ISSUES (–≤–∫–ª—é—á–∞—è Hadolint)
        TOTAL_ISSUES=$DOCKERFILE_ISSUE_COUNT
        
        echo "" >> analysis-results.md
        echo "---" >> analysis-results.md
        if [ "$TOTAL_ISSUES" -gt 0 ]; then
          echo "**Dockerfile Analysis Summary:** Found $TOTAL_ISSUES configuration issues" >> analysis-results.md
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "- üö® Critical: $CRITICAL_COUNT" >> analysis-results.md
          fi
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "- üî¥ High: $HIGH_COUNT" >> analysis-results.md
          fi
          if [ "$MEDIUM_COUNT" -gt 0 ]; then
            echo "- üü° Medium: $MEDIUM_COUNT" >> analysis-results.md
          fi
          if [ "$LOW_COUNT" -gt 0 ]; then
            echo "- üîµ Low: $LOW_COUNT" >> analysis-results.md
          fi
        else
          echo "‚úÖ **Excellent:** No Dockerfile configuration issues found" >> analysis-results.md
        fi
        
        # –û—Ç–¥–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º security vulnerabilities
        if [ "$SBOM_REAL_VULN_COUNT" -gt 0 ]; then
          echo "" >> analysis-results.md
          echo "**Security Status:** ‚ö†Ô∏è $SBOM_REAL_VULN_COUNT vulnerabilities detected in packages" >> analysis-results.md
        else
          echo "" >> analysis-results.md
          echo "**Security Status:** ‚úÖ No vulnerabilities detected" >> analysis-results.md
        fi
        
        echo "issue_count=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
        echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
        echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
        echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
        echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Analysis completed with $TOTAL_ISSUES Dockerfile issues and $SBOM_REAL_VULN_COUNT vulnerabilities"

    # ========== COMPREHENSIVE VULNERABILITY REPORT ==========
    - name: Generate comprehensive vulnerability report
      if: steps.build.outputs.build_success == 'true'
      id: vuln_report
      env:
        SBOM_REAL_VULN_COUNT: ${{ steps.sbom_scan.outputs.sbom_real_vuln_count }}
        SBOM_CRITICAL_COUNT: ${{ steps.sbom_scan.outputs.sbom_critical_count }}
        SBOM_HIGH_COUNT: ${{ steps.sbom_scan.outputs.sbom_high_count }}
        SBOM_MEDIUM_COUNT: ${{ steps.sbom_scan.outputs.sbom_medium_count }}
        SBOM_LOW_COUNT: ${{ steps.sbom_scan.outputs.sbom_low_count }}
        SBOM_UNKNOWN_COUNT: ${{ steps.sbom_scan.outputs.sbom_unknown_count }}
        TRIVY_TOTAL_COUNT: ${{ steps.trivy_scan.outputs.trivy_total_count }}
        TRIVY_CRITICAL_COUNT: ${{ steps.trivy_scan.outputs.trivy_critical_count }}
        TRIVY_HIGH_COUNT: ${{ steps.trivy_scan.outputs.trivy_high_count }}
        TRIVY_MEDIUM_COUNT: ${{ steps.trivy_scan.outputs.trivy_medium_count }}
        TRIVY_LOW_COUNT: ${{ steps.trivy_scan.outputs.trivy_low_count }}
      run: |
        echo "üìä Generating comprehensive vulnerability report..."
        
        echo "# üõ°Ô∏è Comprehensive Security Vulnerability Report" > vulnerability-report.md
        echo "" >> vulnerability-report.md
        echo "**Generated:** $(date)" >> vulnerability-report.md
        echo "**Image:** alpine-secure:latest" >> vulnerability-report.md
        echo "**Alpine Version:** ${{ steps.sbom_generation.outputs.alpine_version }}" >> vulnerability-report.md
        echo "" >> vulnerability-report.md

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö
        if [ "$SBOM_REAL_VULN_COUNT" -gt 0 ]; then
          echo "## üìä Vulnerability Summary" >> vulnerability-report.md
          echo "" >> vulnerability-report.md
          echo "**Grype SBOM Scan:**" >> vulnerability-report.md
          echo "- Total vulnerabilities: $SBOM_REAL_VULN_COUNT" >> vulnerability-report.md
          echo "- Critical: $SBOM_CRITICAL_COUNT" >> vulnerability-report.md
          echo "- High: $SBOM_HIGH_COUNT" >> vulnerability-report.md
          echo "- Medium: $SBOM_MEDIUM_COUNT" >> vulnerability-report.md
          echo "- Low: $SBOM_LOW_COUNT" >> vulnerability-report.md
          echo "- Unknown: $SBOM_UNKNOWN_COUNT" >> vulnerability-report.md
          echo "" >> vulnerability-report.md
        fi

        if [ "$TRIVY_TOTAL_COUNT" -gt 0 ]; then
          echo "**Trivy Image Scan:**" >> vulnerability-report.md
          echo "- Total vulnerabilities: $TRIVY_TOTAL_COUNT" >> vulnerability-report.md
          echo "- CRITICAL: $TRIVY_CRITICAL_COUNT" >> vulnerability-report.md
          echo "- HIGH: $TRIVY_HIGH_COUNT" >> vulnerability-report.md
          echo "- MEDIUM: $TRIVY_MEDIUM_COUNT" >> vulnerability-report.md
          echo "- LOW: $TRIVY_LOW_COUNT" >> vulnerability-report.md
          echo "" >> vulnerability-report.md
        fi

        echo "‚úÖ Comprehensive vulnerability report generated"

    # ========== ARTIFACTS UPLOAD ==========
    - name: Upload all scan reports and artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: alpine-security-full-reports-${{ github.sha }}
        path: |
          # –û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
          analysis-results.md
          security-recommendations.md
          vulnerability-report.md
          grype-detailed-report.md
          package-table.md
          
          # Docker layers —Ñ–∞–π–ª—ã
          docker-layers-detailed.md
          layers-report.md
          docker-layers.txt
          docker-inspect.json
          dive-analysis.json
          
          # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          sbom-scan-all-severities.json
          trivy-results-all-severities.json
          trivy-report.txt
          
          # SBOM —Ñ–∞–π–ª—ã
          sbom.cyclonedx.json
          sbom.spdx.json
          sbom.syft.json
          
          # Docker image –∏ –ª–æ–≥–∏
          alpine-secure-image.tar.gz
          build-output.log
          
          # Linter —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          hadolint-results.json
        retention-days: 30

    # ========== NOTIFICATIONS ==========
    - name: Create Security Issue
      uses: actions/github-script@v6
      if: always()
      env:
        ISSUE_COUNT: ${{ steps.analysis.outputs.issue_count }}
        CRITICAL_COUNT: ${{ steps.analysis.outputs.critical_count }}
        BUILD_SUCCESS: ${{ steps.build.outputs.build_success }}
      with:
        script: |
          const fs = require('fs');
          
          // –ß–∏—Ç–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          const report = fs.existsSync('analysis-results.md') 
            ? fs.readFileSync('analysis-results.md', 'utf8')
            : '## Alpine Security Analysis\n\nAnalysis results not available.';
          
          // –ß–∏—Ç–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–∞–∫–µ—Ç–æ–≤
          const packageTable = fs.existsSync('package-table.md') 
            ? fs.readFileSync('package-table.md', 'utf8')
            : '## üì¶ Packages\n\nPackage information not available.';
          
          const issueCount = process.env.ISSUE_COUNT || 0;
          const criticalCount = process.env.CRITICAL_COUNT || 0;
          const buildSuccess = process.env.BUILD_SUCCESS;
          
          // –ü–ê–†–°–ò–ú Grype —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ù–ê–ü–†–Ø–ú–£–Æ –∏–∑ JSON
          let grypeVulnerabilities = [];
          let totalVulnerabilities = 0;
          let vulnerabilityBreakdown = {
            Critical: 0,
            High: 0,
            Medium: 0,
            Low: 0,
            Unknown: 0,
            None: 0
          };
          
          try {
            if (fs.existsSync('sbom-scan-all-severities.json')) {
              const grypeData = JSON.parse(fs.readFileSync('sbom-scan-all-severities.json', 'utf8'));
              
              if (grypeData.matches && Array.isArray(grypeData.matches)) {
                grypeVulnerabilities = grypeData.matches;
                totalVulnerabilities = grypeVulnerabilities.length;
                
                // –°—á–∏—Ç–∞–µ–º –ø–æ severity
                grypeVulnerabilities.forEach(match => {
                  const severity = match.vulnerability?.severity || 'Unknown';
                  if (vulnerabilityBreakdown[severity] !== undefined) {
                    vulnerabilityBreakdown[severity]++;
                  } else {
                    vulnerabilityBreakdown.Unknown++;
                  }
                });
                
                console.log(`Parsed ${totalVulnerabilities} vulnerabilities from Grype results`);
                console.log('Breakdown:', vulnerabilityBreakdown);
              }
            }
          } catch (error) {
            console.log('Error parsing Grype results:', error.message);
          }
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö
          let title;
          let labels = ['security', 'docker', 'alpine', 'ci-cd', 'automated'];
          
          const realVulnerabilities = vulnerabilityBreakdown.Critical + vulnerabilityBreakdown.High + 
                                    vulnerabilityBreakdown.Medium + vulnerabilityBreakdown.Low + 
                                    vulnerabilityBreakdown.Unknown;
          
          if (buildSuccess === 'false') {
            title = `üö® Alpine Docker Build Failed: ${issueCount} configuration issues found`;
            labels.push('build-failed', 'critical');
          } else if (vulnerabilityBreakdown.Critical > 0) {
            title = `üö® CRITICAL: ${vulnerabilityBreakdown.Critical} critical vulnerabilities in Alpine image`;
            labels.push('critical');
          } else if (vulnerabilityBreakdown.High > 0) {
            title = `üî¥ HIGH: ${vulnerabilityBreakdown.High} high severity vulnerabilities in Alpine image`;
            labels.push('high');
          } else if (realVulnerabilities > 0) {
            title = `‚ö†Ô∏è SECURITY: ${realVulnerabilities} vulnerabilities found in Alpine image`;
            labels.push('security-vulnerabilities');
          } else if (issueCount > 0) {
            title = `üìã Alpine Security Scan: ${issueCount} configuration issues found`;
            labels.push('needs-attention');
          } else {
            title = `‚úÖ Alpine Security Scan: No issues found`;
            labels.push('passed');
          }
          
          // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö
          let vulnerabilityReport = `## üõ°Ô∏è Security Vulnerability Report\n\n`;
          
          if (realVulnerabilities > 0) {
            vulnerabilityReport += `### üìä Vulnerability Summary\n\n`;
            
            vulnerabilityReport += `**Grype SBOM Scan:**\n`;
            vulnerabilityReport += `- Total matches: ${totalVulnerabilities}\n`;
            vulnerabilityReport += `- Real vulnerabilities: ${realVulnerabilities}\n`;
            if (vulnerabilityBreakdown.Critical > 0) vulnerabilityReport += `- üö® Critical: ${vulnerabilityBreakdown.Critical}\n`;
            if (vulnerabilityBreakdown.High > 0) vulnerabilityReport += `- üî¥ High: ${vulnerabilityBreakdown.High}\n`;
            if (vulnerabilityBreakdown.Medium > 0) vulnerabilityReport += `- üü° Medium: ${vulnerabilityBreakdown.Medium}\n`;
            if (vulnerabilityBreakdown.Low > 0) vulnerabilityReport += `- üîµ Low: ${vulnerabilityBreakdown.Low}\n`;
            if (vulnerabilityBreakdown.Unknown > 0) vulnerabilityReport += `- ‚ö™ Unknown: ${vulnerabilityBreakdown.Unknown}\n`;
            vulnerabilityReport += `\n`;
            
            // –û–ì–†–ê–ù–ò–ß–ò–í–ê–ï–ú –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ issue (–ø–µ—Ä–≤—ã–µ 10)
            const maxVulnerabilitiesInIssue = 10;
            const vulnerabilitiesToShow = grypeVulnerabilities.slice(0, maxVulnerabilitiesInIssue);
            const remainingVulnerabilities = grypeVulnerabilities.length - maxVulnerabilitiesInIssue;

            
            if (grypeVulnerabilities.length > 0) {
              vulnerabilityReport += `### üîç Top ${vulnerabilitiesToShow.length} Vulnerabilities\n\n`;
              
              if (remainingVulnerabilities > 0) {
                vulnerabilityReport += `*Showing ${vulnerabilitiesToShow.length} of ${grypeVulnerabilities.length} vulnerabilities. ${remainingVulnerabilities} more in detailed reports.*\n\n`;
              }
              
              vulnerabilitiesToShow.forEach((match, index) => {
                const vuln = match.vulnerability;
                const artifact = match.artifact;
                const severity = vuln.severity || 'Unknown';
                
                // –≠–º–æ–¥–∑–∏ –¥–ª—è severity
                const severityEmoji = {
                  'Critical': 'üö®',
                  'High': 'üî¥', 
                  'Medium': 'üü°',
                  'Low': 'üîµ',
                  'Unknown': '‚ö™',
                  'None': '‚ö´'
                }[severity] || '‚ö™';
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è —Å–ø–∏—Å–æ–∫ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                vulnerabilityReport += `<details>\n`;
                vulnerabilityReport += `<summary><b>${index + 1}. ${vuln.id}</b> ${severityEmoji} ${severity} - ${artifact.name}@${artifact.version}</summary>\n\n`;
                
                vulnerabilityReport += `**Package:** \`${artifact.name}@${artifact.version}\`\n\n`;
                vulnerabilityReport += `**Description:** ${vuln.description || 'No description available'}\n\n`;
                
                // CVSS INFORMATION –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                if (vuln.cvss && vuln.cvss.length > 0) {
                  const primaryCvss = vuln.cvss.find(c => c.type === 'Primary') || vuln.cvss[0];
                  vulnerabilityReport += `**CVSS Score:** ${primaryCvss.metrics.baseScore}/10\n`;
                  
                  if (primaryCvss.vector) {
                    vulnerabilityReport += `**Vector:** \`${primaryCvss.vector}\`\n`;
                  }
                  
                  vulnerabilityReport += `**Metrics:**\n`;
                  vulnerabilityReport += `- Base Score: ${primaryCvss.metrics.baseScore}\n`;
                  if (primaryCvss.metrics.exploitabilityScore) {
                    vulnerabilityReport += `- Exploitability: ${primaryCvss.metrics.exploitabilityScore}\n`;
                  }
                  if (primaryCvss.metrics.impactScore) {
                    vulnerabilityReport += `- Impact: ${primaryCvss.metrics.impactScore}\n`;
                  }
                  vulnerabilityReport += `\n`;
                }
                
                // LAYER INFORMATION
                if (artifact.locations && artifact.locations.length > 0) {
                  const location = artifact.locations[0];
                  vulnerabilityReport += `**Location in Image:**\n`;
                  if (location.layerID) {
                    vulnerabilityReport += `- Layer: \`${location.layerID.substring(0, 20)}...\`\n`;
                  }
                  if (location.path) {
                    vulnerabilityReport += `- Path: \`${location.path}\`\n`;
                  }
                  vulnerabilityReport += `\n`;
                }
                
                // RISK ASSESSMENT
                vulnerabilityReport += `**Risk Assessment:**\n`;
                
                // EPSS –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
                if (vuln.epss && vuln.epss.length > 0) {
                  const epss = vuln.epss[0];
                  const epssPercent = (epss.epss * 100).toFixed(2);
                  const percentile = (epss.percentile * 100).toFixed(2);
                  vulnerabilityReport += `- EPSS: ${epssPercent}% (more exploitable than ${percentile}% of CVEs)\n`;
                }
                
                // Fix information
                if (vuln.fix) {
                  if (vuln.fix.versions && vuln.fix.versions.length > 0) {
                    vulnerabilityReport += `- Fixed in: ${vuln.fix.versions.join(', ')}\n`;
                  } else if (vuln.fix.state) {
                    vulnerabilityReport += `- Fix state: ${vuln.fix.state}\n`;
                  }
                }
                
                // References
                if (vuln.urls && vuln.urls.length > 0) {
                  vulnerabilityReport += `- [View Details](${vuln.urls[0]})\n`;
                }
                
                vulnerabilityReport += `</details>\n\n`;
              });
            }
          } else {
            vulnerabilityReport += `### ‚úÖ No Vulnerabilities Found\n\n`;
            vulnerabilityReport += `Security scanners did not find any vulnerabilities in the Alpine image.\n\n`;
          }

          // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –æ—Ç—á–µ—Ç–∞–º–∏ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
          vulnerabilityReport += `### üìÅ Detailed Reports in Artifacts\n\n`;
          vulnerabilityReport += `For complete technical details, download these files from workflow artifacts:\n\n`;
          
          vulnerabilityReport += `#### üîç Vulnerability Analysis\n`;
          vulnerabilityReport += `| File | Description |\n`;
          vulnerabilityReport += `|------|-------------|\n`;
          vulnerabilityReport += `| \`analysis-results.md\` | Main security analysis with Dockerfile issues |\n`;
          vulnerabilityReport += `| \`vulnerability-report.md\` | Comprehensive vulnerability overview |\n`;
          vulnerabilityReport += `| \`security-recommendations.md\` | Remediation guidance and fixes |\n`;
          vulnerabilityReport += `| \`grype-detailed-report.md\` | Formatted Grype vulnerability list |\n`;
          vulnerabilityReport += `\n`;
          
          vulnerabilityReport += `#### üìä Scanner Results (Raw Data)\n`;
          vulnerabilityReport += `| File | Description |\n`;
          vulnerabilityReport += `|------|-------------|\n`;
          vulnerabilityReport += `| \`sbom-scan-all-severities.json\` | Complete Grype scan results (JSON) |\n`;
          vulnerabilityReport += `| \`trivy-results-all-severities.json\` | Complete Trivy scan results (JSON) |\n`;
          vulnerabilityReport += `| \`trivy-report.txt\` | Trivy text report |\n`;
          vulnerabilityReport += `| \`hadolint-results.json\` | Dockerfile linter results |\n`;
          vulnerabilityReport += `\n`;
          
          vulnerabilityReport += `#### üì¶ Software Bill of Materials\n`;
          vulnerabilityReport += `| File | Description |\n`;
          vulnerabilityReport += `|------|-------------|\n`;
          vulnerabilityReport += `| \`sbom.cyclonedx.json\` | Component list (CycloneDX format) |\n`;
          vulnerabilityReport += `| \`sbom.spdx.json\` | Component list (SPDX format) |\n`;
          vulnerabilityReport += `| \`sbom.syft.json\` | Component list (Syft format) |\n`;
          vulnerabilityReport += `\n`;
          
          vulnerabilityReport += `#### üê≥ Docker Image Analysis\n`;
          vulnerabilityReport += `| File | Description |\n`;
          vulnerabilityReport += `|------|-------------|\n`;
          vulnerabilityReport += `| \`docker-layers-detailed.md\` | Layer commands and sizes |\n`;
          vulnerabilityReport += `| \`layers-report.md\` | Basic layer overview |\n`;
          vulnerabilityReport += `| \`docker-layers.txt\` | Raw layers output |\n`;
          vulnerabilityReport += `| \`docker-inspect.json\` | Image metadata and config |\n`;
          vulnerabilityReport += `| \`dive-analysis.json\` | Layer efficiency analysis |\n`;
          vulnerabilityReport += `| \`alpine-secure-image.tar.gz\` | Docker image archive |\n`;
          vulnerabilityReport += `| \`build-output.log\` | Build process log |\n`;
          vulnerabilityReport += `\n`;

          
          // –î–û–ë–ê–í–õ–Ø–ï–ú –¢–ê–ë–õ–ò–¶–£ –ü–ê–ö–ï–¢–û–í –í ISSUE
          vulnerabilityReport += `## üì¶ Package Inventory\n\n`;
          vulnerabilityReport += `${packageTable}\n\n`;
          
          // –£–ë–ò–†–ê–ï–ú –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –∏ —Å—Å—ã–ª–∫–∏
          vulnerabilityReport += `**To download:** Go to Actions ‚Üí This workflow ‚Üí Artifacts ‚Üí \`alpine-security-full-reports-${context.sha}\`\n\n`;
          
          const detailedReport = `# Alpine Docker Image Security Report
          
          ${report}
          
          ${vulnerabilityReport}
          
          ---
          *Automatically generated by [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*
          `;
          
          const { data: newIssue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: detailedReport,
            labels: labels
          });
          
          console.log(`‚úÖ Created issue #${newIssue.number} with ${realVulnerabilities} vulnerabilities listed`);

  # ========== SECURITY GATES ==========
  security-gates:
    runs-on: ubuntu-latest
    needs: security-scan
    if: always()
    
    steps:
      - name: Check security gates
        env:
          CRITICAL_COUNT: ${{ needs.security-scan.outputs.critical_count }}
          BUILD_SUCCESS: ${{ needs.security-scan.outputs.build_success }}
        run: |
          echo "üîí Checking security gates..."
          if [ "$BUILD_SUCCESS" = "false" ]; then
            echo "‚ùå Alpine Docker build failed - failing workflow"
            exit 1
          fi
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "‚ùå Critical vulnerabilities found: $CRITICAL_COUNT - failing workflow"
            exit 1
          fi
          echo "‚úÖ Alpine security gates passed"
