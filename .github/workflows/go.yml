name: Go CI/CD

on:
  push:
    branches: [ "master", "main", "develop" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  setup:
    name: Initialize and Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true
    
    - name: Initialize Go module if not exists
      run: |
        if [ ! -f go.mod ]; then
          echo "Initializing Go module..."
          go mod init github.com/yourusername/mitre-sync
          # Или, если хотите использовать локальное имя:
          # go mod init mitre-sync
        fi
    
    - name: Tidy dependencies
      run: go mod tidy
    
    - name: Verify module
      run: |
        echo "Go module path:"
        go list -m
        echo -e "\nModule dependencies:"
        go list -m all

  test:
    name: Run Tests
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Install dependencies
      run: go mod download
    
    - name: Check code formatting
      run: |
        # Игнорируем ошибки для первого запуска
        if [ -n "$(gofmt -l . 2>/dev/null)" ]; then
          echo "Warning: Code is not formatted. Consider running 'gofmt -w .'"
          # Не падаем, только предупреждаем
        fi
    
    - name: Build specific binary
      run: |
        # Собираем основной исполняемый файл
        go build -o mitre-sync .
    
    - name: Run tests if they exist
      run: |
        # Пытаемся запустить тесты, если они есть
        if go test ./... -count=1 2>&1 | grep -q "no test files"; then
          echo "No tests found, skipping test execution"
        else
          go test -v ./...
        fi

  build:
    name: Build and Package
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true
    
    - name: Build for multiple platforms
      run: |
        mkdir -p dist
        
        # Linux
        GOOS=linux GOARCH=amd64 go build -o dist/mitre-sync-linux-amd64 .
        
        # macOS
        GOOS=darwin GOARCH=amd64 go build -o dist/mitre-sync-darwin-amd64 .
        
        # Windows
        GOOS=windows GOARCH=amd64 go build -o dist/mitre-sync-windows-amd64.exe .
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: binaries
        path: dist/
